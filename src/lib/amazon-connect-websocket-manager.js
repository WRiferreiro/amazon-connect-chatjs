const global = typeof global !== 'undefined' ? global :
                typeof self !== 'undefined' ? self :
                    typeof window !== 'undefined' ? window : {};
global.connect = global.connect || {};
const currentWebsocketManager = connect.WebSocketManager;

!function(e){var n={};function t(o){if(n[o])return n[o].exports;var r=n[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,t),r.l=!0,r.exports}t.m=e,t.c=n,t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:o})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(t.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var r in e)t.d(o,r,function(n){return e[n]}.bind(null,r));return o},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=10)}([function(e,n){function t(n){return e.exports=t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,t(n)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports},function(e,n){e.exports=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,n){function t(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}e.exports=function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,n){function t(n){return e.exports=t=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},e.exports.__esModule=!0,e.exports.default=e.exports,t(n)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports},function(e,n,t){var o;!function(){"use strict";var r={not_string:/[^s]/,not_bool:/[^t]/,not_type:/[^T]/,not_primitive:/[^v]/,number:/[diefg]/,numeric_arg:/[bcdiefguxX]/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijostTuvxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[+-]/};function i(e){return c(u(e),arguments)}function a(e,n){return i.apply(null,[e].concat(n||[]))}function c(e,n){var t,o,a,c,s,u,l,d,p,f=1,g=e.length,b="";for(o=0;o<g;o++)if("string"==typeof e[o])b+=e[o];else if("object"==typeof e[o]){if((c=e[o]).keys)for(t=n[f],a=0;a<c.keys.length;a++){if(null==t)throw new Error(i('[sprintf] Cannot access property "%s" of undefined value "%s"',c.keys[a],c.keys[a-1]));t=t[c.keys[a]]}else t=c.param_no?n[c.param_no]:n[f++];if(r.not_type.test(c.type)&&r.not_primitive.test(c.type)&&t instanceof Function&&(t=t()),r.numeric_arg.test(c.type)&&"number"!=typeof t&&isNaN(t))throw new TypeError(i("[sprintf] expecting number but found %T",t));switch(r.number.test(c.type)&&(d=t>=0),c.type){case"b":t=parseInt(t,10).toString(2);break;case"c":t=String.fromCharCode(parseInt(t,10));break;case"d":case"i":t=parseInt(t,10);break;case"j":t=JSON.stringify(t,null,c.width?parseInt(c.width):0);break;case"e":t=c.precision?parseFloat(t).toExponential(c.precision):parseFloat(t).toExponential();break;case"f":t=c.precision?parseFloat(t).toFixed(c.precision):parseFloat(t);break;case"g":t=c.precision?String(Number(t.toPrecision(c.precision))):parseFloat(t);break;case"o":t=(parseInt(t,10)>>>0).toString(8);break;case"s":t=String(t),t=c.precision?t.substring(0,c.precision):t;break;case"t":t=String(!!t),t=c.precision?t.substring(0,c.precision):t;break;case"T":t=Object.prototype.toString.call(t).slice(8,-1).toLowerCase(),t=c.precision?t.substring(0,c.precision):t;break;case"u":t=parseInt(t,10)>>>0;break;case"v":t=t.valueOf(),t=c.precision?t.substring(0,c.precision):t;break;case"x":t=(parseInt(t,10)>>>0).toString(16);break;case"X":t=(parseInt(t,10)>>>0).toString(16).toUpperCase()}r.json.test(c.type)?b+=t:(!r.number.test(c.type)||d&&!c.sign?p="":(p=d?"+":"-",t=t.toString().replace(r.sign,"")),u=c.pad_char?"0"===c.pad_char?"0":c.pad_char.charAt(1):" ",l=c.width-(p+t).length,s=c.width&&l>0?u.repeat(l):"",b+=c.align?p+t+s:"0"===u?p+s+t:s+p+t)}return b}var s=Object.create(null);function u(e){if(s[e])return s[e];for(var n,t=e,o=[],i=0;t;){if(null!==(n=r.text.exec(t)))o.push(n[0]);else if(null!==(n=r.modulo.exec(t)))o.push("%");else{if(null===(n=r.placeholder.exec(t)))throw new SyntaxError("[sprintf] unexpected placeholder");if(n[2]){i|=1;var a=[],c=n[2],u=[];if(null===(u=r.key.exec(c)))throw new SyntaxError("[sprintf] failed to parse named argument key");for(a.push(u[1]);""!==(c=c.substring(u[0].length));)if(null!==(u=r.key_access.exec(c)))a.push(u[1]);else{if(null===(u=r.index_access.exec(c)))throw new SyntaxError("[sprintf] failed to parse named argument key");a.push(u[1])}n[2]=a}else i|=2;if(3===i)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");o.push({placeholder:n[0],param_no:n[1],keys:n[2],sign:n[3],pad_char:n[4],align:n[5],width:n[6],precision:n[7],type:n[8]})}t=t.substring(n[0].length)}return s[e]=o}n.sprintf=i,n.vsprintf=a,"undefined"!=typeof window&&(window.sprintf=i,window.vsprintf=a,void 0===(o=function(){return{sprintf:i,vsprintf:a}}.call(n,t,n,e))||(e.exports=o))}()},function(e,n,t){var o=t(8);e.exports=function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),n&&o(e,n)},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,n,t){var o=t(0).default,r=t(9);e.exports=function(e,n){if(n&&("object"===o(n)||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return r(e)},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,n){e.exports=function(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,n){function t(n,o){return e.exports=t=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,n){return e.__proto__=n,e},e.exports.__esModule=!0,e.exports.default=e.exports,t(n,o)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports},function(e,n){e.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e},e.exports.__esModule=!0,e.exports.default=e.exports},function(e,n,t){"use strict";t.r(n),t.d(n,"WebSocketManager",(function(){return Ne}));var o=t(0),r=t.n(o),i=t(4),a="NULL",c="CLIENT_LOGGER",s="DEBUG",u="AMZ_WEB_SOCKET_MANAGER:",l="Network offline",d="Network online, connecting to WebSocket server",p="Network offline, ignoring this getWebSocketConnConfig request",f="Heartbeat response not received",g="aws/ping deep heartbeat response not received",b="Heartbeat response received",v="aws/ping deep heartbeat received",y="Sending heartbeat",m="Sending aws/ping deep heartbeat",h="Failed to send heartbeat since WebSocket is not open",S="Failed to send aws/ping deep heartbeat since WebSocket is not open",w="Deep Heartbeat is successful. WebSocketManager has received 200 response from aws/ping",k="Deep Heartbeat failed. WebSocketManager does not receive 200 response from aws/ping",O="Generic topic failed.",C="WebSocket connection established!",L="WebSocket connection is closed",T="WebSocketManager Error, error_event: ",_="Scheduling WebSocket reinitialization, after delay ",x="WebSocket URL cannot be used to establish connection",W="WebSocket Initialization failed - Terminating and cleaning subscriptions",I="Terminating WebSocket Manager",N="Fetching new WebSocket connection configuration",F="Successfully fetched webSocket connection configuration",E="Failed to fetch webSocket connection configuration",M="Retrying fetching new WebSocket connection configuration",D="Initializing Websocket Manager",R="Initializing Websocket Manager Failure callback registered",A="Websocket connection open callback registered",j="Websocket connection close callback registered",H="Websocket connection gain callback registered",P="Websocket connection lost callback registered",G="Websocket subscription failure callback registered",z="Reset Websocket state",q="WebSocketManager Message Error",U="Message received for topic ",J="Invalid incoming message",B="WebsocketManager invoke callbacks for topic success ",V="aws/subscribe",X="aws/unsubscribe",$="aws/heartbeat",K="aws/ping",Z="connected",Q="disconnected",Y={assertTrue:function(e,n){if(!e)throw new Error(n)},assertNotNull:function(e,n){return Y.assertTrue(null!==e&&void 0!==r()(e),Object(i.sprintf)("%s must be provided",n||"A value")),e},isNonEmptyString:function(e){return"string"==typeof e&&e.length>0},assertIsList:function(e,n){if(!Array.isArray(e))throw new Error(n+" is not an array")},isFunction:function(e){return!!(e&&e.constructor&&e.call&&e.apply)},isObject:function(e){return!("object"!==r()(e)||null===e)},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e}},ee=new RegExp("^(wss://)\\w*"),ne=new RegExp("^(ws://127.0.0.1:)");Y.validWSUrl=function(e){return ee.test(e)||ne.test(e)},Y.getSubscriptionResponse=function(e,n,t){return{topic:e,content:{status:n?"success":"failure",topics:t}}},Y.assertIsObject=function(e,n){if(!Y.isObject(e))throw new Error(n+" is not an object!")},Y.addJitter=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;n=Math.min(n,1);var t=Math.random()>.5?1:-1;return Math.floor(e+t*e*Math.random()*n)},Y.isNetworkOnline=function(){return"undefined"==typeof window||!("navigator"in window)||window.navigator.onLine},Y.isNetworkFailure=function(e){return!(!e._debug||!e._debug.type)&&"NetworkingError"===e._debug.type};var te=Y,oe=t(5),re=t.n(oe),ie=t(6),ae=t.n(ie),ce=t(3),se=t.n(ce),ue=t(7),le=t.n(ue),de=t(1),pe=t.n(de),fe=t(2),ge=t.n(fe);function be(e){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var t,o=se()(e);if(n){var r=se()(this).constructor;t=Reflect.construct(o,arguments,r)}else t=o.apply(this,arguments);return ae()(this,t)}}function ve(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function ye(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?ve(Object(t),!0).forEach((function(n){le()(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ve(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var me=function(){function e(){pe()(this,e)}return ge()(e,[{key:"debug",value:function(e){}},{key:"info",value:function(e){}},{key:"warn",value:function(e){}},{key:"error",value:function(e){}},{key:"advancedLog",value:function(e){}}]),e}(),he=u,Se={DEBUG:10,INFO:20,WARN:30,ERROR:40,ADVANCED_LOG:50},we=function(){function e(n){pe()(this,e),this.logMetaData=n||"",this.updateLoggerConfig()}return ge()(e,[{key:"hasLogMetaData",value:function(){return!!this.logMetaData}},{key:"writeToClientLogger",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(this.hasClientLogger()){var t="string"==typeof n?n:JSON.stringify(n,Le()),o="string"==typeof this.logMetaData?this.logMetaData:JSON.stringify(this.logMetaData,Le()),r="".concat(Ce(e)," ").concat(t," ").concat(o);switch(e){case Se.DEBUG:return this._clientLogger.debug(r)||r;case Se.INFO:return this._clientLogger.info(r)||r;case Se.WARN:return this._clientLogger.warn(r)||r;case Se.ERROR:return this._clientLogger.error(r)||r;case Se.ADVANCED_LOG:return this._advancedLogWriter?this._clientLogger[this._advancedLogWriter](r)||r:""}}}},{key:"isLevelEnabled",value:function(e){return e>=this._level}},{key:"hasClientLogger",value:function(){return null!==this._clientLogger}},{key:"getLogger",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.prefix||he;return e.logMetaData&&this.setLogMetaData(e.logMetaData),this.logMetaData||console.info("*********Missing required option: WebSocketManager:logMetaData**********"),new Oe(this,ye({prefix:n,logMetaData:this.logMetaData},e))}},{key:"setLogMetaData",value:function(e){this.logMetaData=e}},{key:"updateLoggerConfig",value:function(e){var n=e||{};this._level=n.level||Se.INFO,this._advancedLogWriter="warn",n.advancedLogWriter&&(this._advancedLogWriter=n.advancedLogWriter),n.customizedLogger&&"object"===r()(n.customizedLogger)&&(this.useClientLogger=!0),this._clientLogger=n.logger||this.selectLogger(n),this._logsDestination=a,n.debug&&(this._logsDestination=s),n.logger&&(this._logsDestination=c)}},{key:"selectLogger",value:function(e){return e.customizedLogger&&"object"===r()(e.customizedLogger)?e.customizedLogger:e.useDefaultLogger?Te():null}}]),e}(),ke=function(){function e(){pe()(this,e)}return ge()(e,[{key:"debug",value:function(){}},{key:"info",value:function(){}},{key:"warn",value:function(){}},{key:"error",value:function(){}},{key:"advancedLog",value:function(){}}]),e}(),Oe=function(e){re()(t,e);var n=be(t);function t(e,o){var r;return pe()(this,t),(r=n.call(this)).options=o||{},r.prefix=o.prefix||he,r.logManager=e,r}return ge()(t,[{key:"debug",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return this._log(Se.DEBUG,n)}},{key:"info",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return this._log(Se.INFO,n)}},{key:"warn",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return this._log(Se.WARN,n)}},{key:"error",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return this._log(Se.ERROR,n)}},{key:"advancedLog",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return this._log(Se.ADVANCED_LOG,n)}},{key:"_shouldLog",value:function(e){return this.logManager.hasClientLogger()&&this.logManager.isLevelEnabled(e)}},{key:"_writeToClientLogger",value:function(e,n){return this.logManager.writeToClientLogger(e,n)}},{key:"_log",value:function(e,n){if(this._shouldLog(e)){var t=this.logManager.useClientLogger?n:this._convertToSingleStatement(n);return this._writeToClientLogger(e,t)}}},{key:"_convertToSingleStatement",value:function(e){var n=new Date(Date.now()).toISOString(),t="[".concat(n,"]");this.prefix&&(t+=this.prefix+" "),this.options&&(this.options.prefix?t+=" "+this.options.prefix+":":t+="");for(var o=0;o<e.length;o++){var r=e[o];t+=this._convertToString(r)+" "}return t}},{key:"_convertToString",value:function(e){try{if(!e)return"";if(te.isString(e))return e;if(te.isObject(e)&&te.isFunction(e.toString)){var n=e.toString();if("[object Object]"!==n)return n}return JSON.stringify(e)}catch(n){return console.error("Error while converting argument to string",e,n),""}}}]),t}(ke);function Ce(e){switch(e){case 10:return"DEBUG";case 20:return"INFO";case 30:return"WARN";case 40:return"ERROR";case 50:return"ADVANCED_LOG"}}function Le(){var e=new WeakSet;return function(n,t){if("object"===r()(t)&&null!==t){if(e.has(t))return;e.add(t)}return t}}var Te=function(){var e=new ke;return e.debug=function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return console.debug.apply(window.console,[].concat(n))},e.info=function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return console.info.apply(window.console,[].concat(n))},e.warn=function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return console.warn.apply(window.console,[].concat(n))},e.error=function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return console.error.apply(window.console,[].concat(n))},e},_e=function(){function e(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2e3;pe()(this,e),this.numAttempts=0,this.executor=n,this.hasActiveReconnection=!1,this.defaultRetry=t}return ge()(e,[{key:"retry",value:function(){var e=this;this.hasActiveReconnection||(this.hasActiveReconnection=!0,setTimeout((function(){e._execute()}),this._getDelay()))}},{key:"_execute",value:function(){this.hasActiveReconnection=!1,this.executor(),this.numAttempts++}},{key:"connected",value:function(){this.numAttempts=0}},{key:"_getDelay",value:function(){var e=Math.pow(2,this.numAttempts)*this.defaultRetry;return e<=3e4?e:3e4}},{key:"getIsConnected",value:function(){return!this.numAttempts}}]),e}(),xe=null,We=function(){var e=!1,n=xe.getLogger({prefix:u}),t=te.isNetworkOnline(),o={primary:null,secondary:null},r={reconnectWebSocket:!0,websocketInitFailed:!1,exponentialBackOffTime:1e3,exponentialTimeoutHandle:null,lifeTimeTimeoutHandle:null,webSocketInitCheckerTimeoutId:null,connState:null},i={connectWebSocketRetryCount:0,connectionAttemptStartTime:null,noOpenConnectionsTimestamp:null},a={pendingResponse:!1,intervalHandle:null},c={pendingResponse:!1,intervalHandle:null},s={initFailure:new Set,getWebSocketTransport:null,subscriptionUpdate:new Set,subscriptionFailure:new Set,topic:new Map,allMessage:new Set,connectionGain:new Set,connectionLost:new Set,connectionOpen:new Set,connectionClose:new Set,deepHeartbeatSuccess:new Set,deepHeartbeatFailure:new Set,topicFailure:new Set},Y={connConfig:null,promiseHandle:null,promiseCompleted:!0},ee={subscribed:new Set,pending:new Set,subscriptionHistory:new Set},ne={responseCheckIntervalId:null,requestCompleted:!0,reSubscribeIntervalId:null,consecutiveFailedSubscribeAttempts:0,consecutiveNoResponseRequest:0},oe=new _e((function(){Ie()})),re=new Set([V,X,$,K]),ie=setInterval((function(){if(t!==te.isNetworkOnline()){if(!(t=te.isNetworkOnline()))return n.advancedLog(l),void Ee(n.info(l));var e=pe();t&&(!e||ue(e,WebSocket.CLOSING)||ue(e,WebSocket.CLOSED))&&(n.advancedLog(d),Ee(n.info(d)),Ie())}}),250),ae=function(e,t){e.forEach((function(e){try{e(t)}catch(e){Ee(n.error("Error executing callback",e))}}))},ce=function(e){if(null===e)return"NULL";switch(e.readyState){case WebSocket.CONNECTING:return"CONNECTING";case WebSocket.OPEN:return"OPEN";case WebSocket.CLOSING:return"CLOSING";case WebSocket.CLOSED:return"CLOSED";default:return"UNDEFINED"}},se=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";Ee(n.debug("["+e+"] Primary WebSocket: "+ce(o.primary)+" | Secondary WebSocket: "+ce(o.secondary)))},ue=function(e,n){return e&&e.readyState===n},le=function(e){return ue(e,WebSocket.OPEN)},de=function(e){return null===e||void 0===e.readyState||ue(e,WebSocket.CLOSED)},pe=function(){return null!==o.secondary?o.secondary:o.primary},fe=function(){return le(pe())},ge=function(){if(e&&c.pendingResponse&&(n.advancedLog(g),Ee(n.warn(g)),ae(s.deepHeartbeatFailure,{timestamp:Date.now(),error:"aws/ping response is not received"}),clearInterval(c.intervalHandle),c.pendingResponse=!1),a.pendingResponse)return n.advancedLog(f),Ee(n.warn(f)),clearInterval(a.intervalHandle),a.pendingResponse=!1,void Ie();fe()?(e&&(Ee(n.debug(m)),pe().send(Te(K)),c.pendingResponse=!0),Ee(n.debug(y)),pe().send(Te($)),a.pendingResponse=!0):(e&&(n.advancedLog(S),Ee(n.warn(S)),ae(s.deepHeartbeatFailure,{timestamp:Date.now(),error:"Unable to send message to aws/ping because websocket connection is not established."})),n.advancedLog(h),Ee(n.warn(h)),se("sendHeartBeat"),Ie())},be=function(){n.advancedLog(z),r.exponentialBackOffTime=1e3,a.pendingResponse=!1,c.pendingResponse=!1,r.reconnectWebSocket=!0,clearTimeout(r.lifeTimeTimeoutHandle),clearInterval(a.intervalHandle),clearInterval(c.intervalHandle),clearTimeout(r.exponentialTimeoutHandle),clearTimeout(r.webSocketInitCheckerTimeoutId)},ve=function(){ne.consecutiveFailedSubscribeAttempts=0,ne.consecutiveNoResponseRequest=0,clearInterval(ne.responseCheckIntervalId),clearInterval(ne.reSubscribeIntervalId)},ye=function(){i.connectWebSocketRetryCount=0,i.connectionAttemptStartTime=null,i.noOpenConnectionsTimestamp=null},me=function(){oe.connected();try{n.advancedLog(C),Ee(n.info(C)),se("webSocketOnOpen"),null!==r.connState&&r.connState!==Q||ae(s.connectionGain),r.connState=Z;var e=Date.now();ae(s.connectionOpen,{connectWebSocketRetryCount:i.connectWebSocketRetryCount,connectionAttemptStartTime:i.connectionAttemptStartTime,noOpenConnectionsTimestamp:i.noOpenConnectionsTimestamp,connectionEstablishedTime:e,timeToConnect:e-i.connectionAttemptStartTime,timeWithoutConnection:i.noOpenConnectionsTimestamp?e-i.noOpenConnectionsTimestamp:null}),ye(),be(),pe().openTimestamp=Date.now(),0===ee.subscribed.size&&le(o.secondary)&&ke(o.primary,"[Primary WebSocket] Closing WebSocket"),(ee.subscribed.size>0||ee.pending.size>0)&&(le(o.secondary)&&Ee(n.info("Subscribing secondary websocket to topics of primary websocket")),ee.subscribed.forEach((function(e){ee.subscriptionHistory.add(e),ee.pending.add(e)})),ee.subscribed.clear(),we()),ge(),a.intervalHandle=setInterval(ge,1e4);var t=1e3*Y.connConfig.webSocketTransport.transportLifeTimeInSeconds;Ee(n.debug("Scheduling WebSocket manager reconnection, after delay "+t+" ms")),r.lifeTimeTimeoutHandle=setTimeout((function(){Ee(n.debug("Starting scheduled WebSocket manager reconnection")),Ie()}),t)}catch(e){Ee(n.error("Error after establishing WebSocket connection",e))}},he=function(e){se("webSocketOnError"),n.advancedLog(T,JSON.stringify(e)),Ee(n.error(T,JSON.stringify(e))),oe.getIsConnected()?Ie():oe.retry()},Se=function(e){var t=JSON.parse(e.data);switch(t.topic){case V:if(Ee(n.debug("Subscription Message received from webSocket server",e.data)),ne.requestCompleted=!0,ne.consecutiveNoResponseRequest=0,"success"===t.content.status)ne.consecutiveFailedSubscribeAttempts=0,t.content.topics.forEach((function(e){ee.subscriptionHistory.delete(e),ee.pending.delete(e),ee.subscribed.add(e)})),0===ee.subscriptionHistory.size?le(o.secondary)&&(Ee(n.info("Successfully subscribed secondary websocket to all topics of primary websocket")),ke(o.primary,"[Primary WebSocket] Closing WebSocket")):we(),ae(s.subscriptionUpdate,t);else{if(clearInterval(ne.reSubscribeIntervalId),++ne.consecutiveFailedSubscribeAttempts,5===ne.consecutiveFailedSubscribeAttempts)return ae(s.subscriptionFailure,t),void(ne.consecutiveFailedSubscribeAttempts=0);ne.reSubscribeIntervalId=setInterval((function(){we()}),500)}break;case $:Ee(n.debug(b)),a.pendingResponse=!1;break;case K:Ee(n.debug(v)),c.pendingResponse=!1,200===t.statusCode?ae(s.deepHeartbeatSuccess,{timestamp:Date.now()}):ae(s.deepHeartbeatFailure,{timestamp:Date.now(),statusCode:t.statusCode,statusContent:t.statusContent});break;default:if(t.topic){if(n.advancedLog(U,t.topic),Ee(n.debug(U+t.topic)),le(o.primary)&&le(o.secondary)&&0===ee.subscriptionHistory.size&&this===o.primary)return void Ee(n.warn("Ignoring Message for Topic "+t.topic+", to avoid duplicates"));if(0===s.allMessage.size&&0===s.topic.size)return void Ee(n.warn("No registered callback listener for Topic",t.topic));n.advancedLog(B,t.topic),ae(s.allMessage,t),s.topic.has(t.topic)&&ae(s.topic.get(t.topic),t)}else t.message?(n.advancedLog(q,t),Ee(n.warn(q,t)),ae(s.topicFailure,{timestamp:Date.now(),errorMessage:t.message,connectionId:t.connectionId,requestId:t.requestId})):(n.advancedLog(J,t),Ee(n.warn(J,t)))}},we=function e(){if(ne.consecutiveNoResponseRequest>3)return Ee(n.warn("Ignoring subscribePendingTopics since we have exhausted max subscription retries with no response")),void ae(s.subscriptionFailure,te.getSubscriptionResponse(V,!1,Array.from(ee.pending)));fe()?0!==Array.from(ee.pending).length&&(clearInterval(ne.responseCheckIntervalId),pe().send(Te(V,{topics:Array.from(ee.pending)})),ne.requestCompleted=!1,ne.responseCheckIntervalId=setInterval((function(){ne.requestCompleted||(++ne.consecutiveNoResponseRequest,e())}),1e3)):Ee(n.warn("Ignoring subscribePendingTopics call since Default WebSocket is not open"))},ke=function(e,t){ue(e,WebSocket.CONNECTING)||ue(e,WebSocket.OPEN)?e.close(1e3,t):Ee(n.warn("Ignoring WebSocket Close request, WebSocket State: "+ce(e)))},Oe=function(e){ke(o.primary,"[Primary] WebSocket "+e),ke(o.secondary,"[Secondary] WebSocket "+e)},Ce=function(){i.connectWebSocketRetryCount++;var e=te.addJitter(r.exponentialBackOffTime,.3);Date.now()+e<=Y.connConfig.urlConnValidTime?(n.advancedLog(_),Ee(n.debug(_+e+" ms")),r.exponentialTimeoutHandle=setTimeout((function(){return Ne()}),e),r.exponentialBackOffTime*=2):(n.advancedLog(x),Ee(n.warn(x)),Ie())},Le=function(e){be(),ve(),n.advancedLog(W,e),Ee(n.error(W)),r.websocketInitFailed=!0,Oe(I),clearInterval(ie),ae(s.initFailure,{connectWebSocketRetryCount:i.connectWebSocketRetryCount,connectionAttemptStartTime:i.connectionAttemptStartTime,reason:e}),ye()},Te=function(e,n){return JSON.stringify({topic:e,content:n})},We=function(e){return!!(te.isObject(e)&&te.isObject(e.webSocketTransport)&&te.isNonEmptyString(e.webSocketTransport.url)&&te.validWSUrl(e.webSocketTransport.url)&&1e3*e.webSocketTransport.transportLifeTimeInSeconds>=3e5)||(Ee(n.error("Invalid WebSocket Connection Configuration",e)),!1)},Ie=function(){if(!te.isNetworkOnline())return n.advancedLog(p),void Ee(n.info(p));if(r.websocketInitFailed)Ee(n.debug("WebSocket Init had failed, ignoring this getWebSocketConnConfig request"));else{if(Y.promiseCompleted)return be(),n.advancedLog(N),Ee(n.info(N)),i.connectionAttemptStartTime=i.connectionAttemptStartTime||Date.now(),Y.promiseCompleted=!1,Y.promiseHandle=s.getWebSocketTransport(),Y.promiseHandle.then((function(e){return Y.promiseCompleted=!0,n.advancedLog(F),Ee(n.debug(F,e)),We(e)?(Y.connConfig=e,Y.connConfig.urlConnValidTime=Date.now()+85e3,Ne()):(Le("Invalid WebSocket connection configuration: "+e),{webSocketConnectionFailed:!0})}),(function(e){return Y.promiseCompleted=!0,n.advancedLog(E),Ee(n.error(E,e)),te.isNetworkFailure(e)?(n.advancedLog(M+JSON.stringify(e)),Ee(n.info(M+JSON.stringify(e))),oe.retry()):Le("Failed to fetch webSocket connection configuration: "+JSON.stringify(e)),{webSocketConnectionFailed:!0}}));Ee(n.debug("There is an ongoing getWebSocketConnConfig request, this request will be ignored"))}},Ne=function(){if(r.websocketInitFailed)return Ee(n.info("web-socket initializing had failed, aborting re-init")),{webSocketConnectionFailed:!0};if(!te.isNetworkOnline())return Ee(n.warn("System is offline aborting web-socket init")),{webSocketConnectionFailed:!0};n.advancedLog(D),Ee(n.info(D)),se("initWebSocket");try{if(We(Y.connConfig)){var e=null;return le(o.primary)?(Ee(n.debug("Primary Socket connection is already open")),ue(o.secondary,WebSocket.CONNECTING)||(Ee(n.debug("Establishing a secondary web-socket connection")),oe.numAttempts=0,o.secondary=Fe()),e=o.secondary):(ue(o.primary,WebSocket.CONNECTING)||(Ee(n.debug("Establishing a primary web-socket connection")),o.primary=Fe()),e=o.primary),r.webSocketInitCheckerTimeoutId=setTimeout((function(){le(e)||Ce()}),1e3),{webSocketConnectionFailed:!1}}}catch(e){return Ee(n.error("Error Initializing web-socket-manager",e)),Le("Failed to initialize new WebSocket: "+e.message),{webSocketConnectionFailed:!0}}},Fe=function(){var e=new WebSocket(Y.connConfig.webSocketTransport.url);return e.addEventListener("open",me),e.addEventListener("message",Se),e.addEventListener("error",he),e.addEventListener("close",(function(t){return function(e,t){n.advancedLog(L,JSON.stringify(e)),Ee(n.info(L,JSON.stringify(e))),se("webSocketOnClose before-cleanup"),ae(s.connectionClose,{openTimestamp:t.openTimestamp,closeTimestamp:Date.now(),connectionDuration:Date.now()-t.openTimestamp,code:e.code,reason:e.reason}),de(o.primary)&&(o.primary=null),de(o.secondary)&&(o.secondary=null),r.reconnectWebSocket&&(le(o.primary)||le(o.secondary)?de(o.primary)&&le(o.secondary)&&(Ee(n.info("[Primary] WebSocket Cleanly Closed")),o.primary=o.secondary,o.secondary=null):(Ee(n.warn("Neither primary websocket and nor secondary websocket have open connections, attempting to re-establish connection")),r.connState===Q?Ee(n.info("Ignoring connectionLost callback invocation")):(ae(s.connectionLost,{openTimestamp:t.openTimestamp,closeTimestamp:Date.now(),connectionDuration:Date.now()-t.openTimestamp,code:e.code,reason:e.reason}),i.noOpenConnectionsTimestamp=Date.now()),r.connState=Q,Ie()),se("webSocketOnClose after-cleanup"))}(t,e)})),e},Ee=function(e){return e&&"function"==typeof e.sendInternalLogToServer&&e.sendInternalLogToServer(),e};this.init=function(e){if(te.assertTrue(te.isFunction(e),"transportHandle must be a function"),null===s.getWebSocketTransport)return s.getWebSocketTransport=e,Ie();Ee(n.warn("Web Socket Manager was already initialized"))},this.onInitFailure=function(e){return n.advancedLog(R),te.assertTrue(te.isFunction(e),"cb must be a function"),s.initFailure.add(e),r.websocketInitFailed&&e(),function(){return s.initFailure.delete(e)}},this.onConnectionOpen=function(e){return n.advancedLog(A),te.assertTrue(te.isFunction(e),"cb must be a function"),s.connectionOpen.add(e),function(){return s.connectionOpen.delete(e)}},this.onConnectionClose=function(e){return n.advancedLog(j),te.assertTrue(te.isFunction(e),"cb must be a function"),s.connectionClose.add(e),function(){return s.connectionClose.delete(e)}},this.onConnectionGain=function(e){return n.advancedLog(H),te.assertTrue(te.isFunction(e),"cb must be a function"),s.connectionGain.add(e),fe()&&e(),function(){return s.connectionGain.delete(e)}},this.onConnectionLost=function(e){return n.advancedLog(P),te.assertTrue(te.isFunction(e),"cb must be a function"),s.connectionLost.add(e),r.connState===Q&&e(),function(){return s.connectionLost.delete(e)}},this.onSubscriptionUpdate=function(e){return te.assertTrue(te.isFunction(e),"cb must be a function"),s.subscriptionUpdate.add(e),function(){return s.subscriptionUpdate.delete(e)}},this.onSubscriptionFailure=function(e){return n.advancedLog(G),te.assertTrue(te.isFunction(e),"cb must be a function"),s.subscriptionFailure.add(e),function(){return s.subscriptionFailure.delete(e)}},this.onMessage=function(e,n){return te.assertNotNull(e,"topicName"),te.assertTrue(te.isFunction(n),"cb must be a function"),s.topic.has(e)?s.topic.get(e).add(n):s.topic.set(e,new Set([n])),function(){return s.topic.get(e).delete(n)}},this.onAllMessage=function(e){return te.assertTrue(te.isFunction(e),"cb must be a function"),s.allMessage.add(e),function(){return s.allMessage.delete(e)}},this.subscribeTopics=function(e){te.assertNotNull(e,"topics"),te.assertIsList(e),e.forEach((function(e){ee.subscribed.has(e)||ee.pending.add(e)})),ne.consecutiveNoResponseRequest=0,we()},this.sendMessage=function(e){if(te.assertIsObject(e,"payload"),void 0===e.topic||re.has(e.topic))Ee(n.warn("Cannot send message, Invalid topic",e));else{try{e=JSON.stringify(e)}catch(t){return void Ee(n.warn("Error stringify message",e))}fe()?pe().send(e):Ee(n.warn("Cannot send message, web socket connection is not open"))}},this.deepHeartbeatHandler=function(){e=!0},this.onDeepHeartbeatSuccess=function(e){return n.advancedLog(w),te.assertTrue(te.isFunction(e),"cb must be a function"),s.deepHeartbeatSuccess.add(e),function(){return s.deepHeartbeatSuccess.delete(e)}},this.onDeepHeartbeatFailure=function(e){return n.advancedLog(k),te.assertTrue(te.isFunction(e),"cb must be a function"),s.deepHeartbeatFailure.add(e),function(){return s.deepHeartbeatFailure.delete(e)}},this.onTopicFailure=function(e){return n.advancedLog(O),te.assertTrue(te.isFunction(e),"cb must be a function"),s.topicFailure.add(e),function(){return s.topicFailure.delete(e)}},this.closeWebSocket=function(){be(),ve(),r.reconnectWebSocket=!1,clearInterval(ie),Oe("User request to close WebSocket")},this.terminateWebSocketManager=Le},Ie={create:function(e){return xe||(xe=new we(e)),xe.hasLogMetaData()||xe.setLogMetaData(e),e||console.info("********Missing metaData for logs from websocketManager: initialize websocketManager using create(metaData)*******"),new We},setGlobalConfig:function(e){var n=e&&e.loggerConfig;xe||(xe=new we),xe.updateLoggerConfig(n)},LogLevel:Se,Logger:me};global.connect=global.connect||{},connect.WebSocketManager=Ie;var Ne=Ie;n.default=Ne}]);
//# sourceMappingURL=amazon-connect-websocket-manager.js.map

const WebSocketManager = connect.WebSocketManager;
connect.WebSocketManager = currentWebsocketManager || WebSocketManager;
export default WebSocketManager;
